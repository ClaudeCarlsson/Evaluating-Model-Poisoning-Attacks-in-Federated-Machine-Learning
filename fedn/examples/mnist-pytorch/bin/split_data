#!./.mnist-pytorch/bin/python
import os
from math import floor

import fire
import torch
import torchvision


def splitset(dataset, parts):
    n = dataset.shape[0]
    local_n = floor(n/parts)
    result = []
    for i in range(parts):
        result.append(dataset[i*local_n: (i+1)*local_n])
    return result


def split(out_dir='data', n_splits=2):
    # Make dir
    if not os.path.exists(f'{out_dir}/clients'):
        os.mkdir(f'{out_dir}/clients')

    # Load data
    train_data = torchvision.datasets.MNIST(
        root=f'{out_dir}/train', transform=torchvision.transforms.ToTensor, train=True)
    test_data = torchvision.datasets.MNIST(
        root=f'{out_dir}/test', transform=torchvision.transforms.ToTensor, train=False)
    
    # Create shuffled arrays of ints from 0 to n-1
    train_indices = torch.randperm(len(train_data))
    test_indices = torch.randperm(len(test_data))

    # Use shuffled indices to split datasets
    shuffled_train_data = train_data.data[train_indices]
    shuffled_train_targets = train_data.targets[train_indices]
    shuffled_test_data = test_data.data[test_indices]
    shuffled_test_targets = test_data.targets[test_indices]
    
    # Convert to dict
    data = {
        'x_train': splitset(shuffled_train_data, n_splits),
        'y_train': splitset(shuffled_train_targets, n_splits),
        'x_test': splitset(shuffled_test_data, n_splits),
        'y_test': splitset(shuffled_test_targets, n_splits),
    }

    # Make splits
    for i in range(n_splits):
        subdir = f'{out_dir}/clients/{str(i+1)}'
        if not os.path.exists(subdir):
            os.mkdir(subdir)
        torch.save({
            'x_train': data['x_train'][i],
            'y_train': data['y_train'][i],
            'x_test': data['x_test'][i],
            'y_test': data['y_test'][i],
        },
            f'{subdir}/mnist.pt')


if __name__ == '__main__':
    fire.Fire(split)
